<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4F46E5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Workout Tracker</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #4F46E5;
            --primary-dark: #4338CA;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --text-primary: #1F2937;
            --text-secondary: #6B7280;
            --bg-primary: #FFFFFF;
            --bg-secondary: #F3F4F6;
            --border: #E5E7EB;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Header */
        .header {
            background: var(--primary);
            color: white;
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 100%;
        }

        .header-title {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .program-selector {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            min-height: 44px;
            min-width: 100px;
        }

        /* Navigation */
        .nav-bar {
            display: flex;
            background: white;
            padding: 0.75rem;
            gap: 0.75rem;
            box-shadow: 0 1px 3px var(--shadow);
        }

        .nav-btn {
            flex: 1;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            color: var(--text-primary);
            padding: 0.875rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .nav-btn:active {
            transform: scale(0.98);
            background: var(--primary);
            color: white;
        }

        .nav-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .day-indicator {
            background: white;
            padding: 1rem;
            text-align: center;
            font-weight: 600;
            font-size: 1.125rem;
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }

        /* Main Content */
        .container {
            padding: 1rem;
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: 5rem;
        }

        .workout-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--bg-secondary);
        }

        .exercise-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            flex: 1;
            line-height: 1.3;
        }

        .exercise-number {
            background: var(--primary);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.125rem;
            flex-shrink: 0;
            margin-left: 1rem;
        }

        /* Exercise Details */
        .exercise-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 12px;
        }

        .detail-item {
            text-align: center;
        }

        .detail-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .detail-value {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--primary);
        }

        /* Sets */
        .sets-container {
            margin-top: 1.5rem;
        }

        .set-header {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }

        .set-row {
            display: grid;
            grid-template-columns: 50px 1fr 1fr 48px;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            align-items: center;
        }

        .set-label {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 1rem;
            text-align: center;
            background: var(--bg-secondary);
            padding: 0.75rem 0.5rem;
            border-radius: 8px;
        }

        .input-group {
            position: relative;
        }

        .input-field {
            width: 100%;
            padding: 0.875rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1.125rem;
            font-weight: 600;
            text-align: center;
            transition: all 0.2s;
            background: white;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .input-label {
            position: absolute;
            top: -8px;
            left: 12px;
            background: white;
            padding: 0 4px;
            font-size: 0.625rem;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .check-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid var(--border);
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .check-btn:active {
            transform: scale(0.95);
        }

        .check-btn.completed {
            background: var(--success);
            border-color: var(--success);
        }

        .check-btn .checkmark {
            display: none;
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .check-btn.completed .checkmark {
            display: block;
        }

        /* Previous Results */
        .previous-results {
            margin-top: 1.5rem;
            padding: 1rem;
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            border-radius: 12px;
            border-left: 4px solid var(--warning);
        }

        .previous-label {
            font-size: 0.75rem;
            color: #92400E;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .previous-value {
            font-size: 1rem;
            color: #78350F;
            font-weight: 600;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1.5rem;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
        }

        .empty-subtext {
            font-size: 0.875rem;
        }

        /* Bottom Actions */
        .bottom-actions {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 1rem;
            box-shadow: 0 -2px 8px var(--shadow);
            z-index: 50;
        }

        .complete-workout-btn {
            width: 100%;
            padding: 1rem;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.125rem;
            font-weight: 700;
            cursor: pointer;
            min-height: 56px;
            transition: all 0.2s;
        }

        .complete-workout-btn:active {
            transform: scale(0.98);
            background: #059669;
        }

        /* Loading State */
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--bg-secondary);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text-primary);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Responsive */
        @media (max-width: 480px) {
            .exercise-details {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .detail-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.5rem;
            }

            .detail-label {
                text-align: left;
            }

            .detail-value {
                text-align: right;
            }
        }

        @media (max-width: 360px) {
            .exercise-name {
                font-size: 1.125rem;
            }

            .set-row {
                grid-template-columns: 40px 1fr 1fr 44px;
                gap: 0.5rem;
            }

            .input-field {
                font-size: 1rem;
                padding: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <h1 class="header-title">Workout Tracker</h1>
            <select class="program-selector" id="weekSelector">
                <option value="1">Week 1</option>
                <option value="2">Week 2</option>
            </select>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav-bar">
        <button class="nav-btn" id="prevDayBtn">
            <span>◄</span>
            <span>Previous</span>
        </button>
        <button class="nav-btn" id="nextDayBtn">
            <span>Next</span>
            <span>►</span>
        </button>
    </nav>

    <!-- Day Indicator -->
    <div class="day-indicator" id="dayIndicator">Day 1</div>

    <!-- Loading State -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Loading workout...</p>
    </div>

    <!-- Main Content -->
    <main class="container" id="workoutContainer">
        <!-- Workout cards will be dynamically generated here -->
    </main>

    <!-- Bottom Actions -->
    <div class="bottom-actions">
        <button class="complete-workout-btn" id="completeWorkoutBtn">
            Complete Workout
        </button>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script type="module">
        // Import weight suggestion functionality
        import {
            renderSuggestionCard,
            getSuggestionForExercise,
            isSuggestionDismissed,
            handleAcceptSuggestion
        } from './ui/suggestionCard.js';

        import { getWeek1Results } from './utils/weightSuggestions.js';

        // Application State
        const state = {
            currentProgram: 'sheet1',
            currentWeek: 1,
            currentDay: 1,
            workouts: {},
            completedSets: {},
            previousResults: {},
            workoutData: null
        };

        // Parse sets/reps string (e.g., "2x18-20" or "2x10ea")
        function parseSetsReps(setsRepsStr) {
            if (!setsRepsStr) return { sets: 0, reps: '0' };

            // Handle formats: "2x18-20", "2x10ea", "2x20-25"
            const match = setsRepsStr.match(/(\d+)x([\d-]+)/);
            if (!match) return { sets: 0, reps: setsRepsStr };

            const sets = parseInt(match[1]);
            let reps = match[2];

            // Remove "ea" if present
            reps = reps.replace('ea', '').trim();

            return { sets, reps };
        }

        // Load workout data from JSON
        async function loadWorkoutData() {
            try {
                const response = await fetch('sheet1-workout-data.json');
                const data = await response.json();
                state.workoutData = data;
                return data;
            } catch (error) {
                console.error('Failed to load workout data:', error);
                showToast('Failed to load workout data');
                return null;
            }
        }

        // Get exercises for current selection
        function getCurrentExercises() {
            if (!state.workoutData || !state.workoutData.weeks) return [];

            const week = state.workoutData.weeks.find(w => w.week === state.currentWeek);
            if (!week || !week.days) return [];

            const day = week.days.find(d => d.day === state.currentDay);
            if (!day || !day.exercises) return [];

            // Transform exercises to UI format
            return day.exercises.map(ex => {
                const { sets, reps } = parseSetsReps(ex.sets_reps);
                return {
                    id: ex.exercise_id,
                    name: ex.exercise_name,
                    sets: sets,
                    reps: reps,
                    tempo: ex.tempo || '-',
                    rest: ex.rest || '-',
                    setsRepsRaw: ex.sets_reps || '',
                    previousResults: ''
                };
            });
        }

        // Get max days for current sheet
        function getMaxDays() {
            if (!state.workoutData || !state.workoutData.weeks) return 1;

            const week = state.workoutData.weeks.find(w => w.week === state.currentWeek);
            if (!week || !week.days) return 1;

            return week.days.length;
        }

        // Get max weeks
        function getMaxWeeks() {
            if (!state.workoutData || !state.workoutData.weeks) return 1;
            return state.workoutData.weeks.length;
        }

        // Initialize app
        async function initApp() {
            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('workoutContainer').style.display = 'none';

            await loadWorkoutData();
            loadState();
            autoMigrateData(); // Auto-fix old string data to numbers
            setupEventListeners();

            // Hide loading
            document.getElementById('loading').style.display = 'none';
            document.getElementById('workoutContainer').style.display = 'block';

            renderWorkout();
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('weekSelector').addEventListener('change', handleWeekChange);
            document.getElementById('prevDayBtn').addEventListener('click', () => changeDay(-1));
            document.getElementById('nextDayBtn').addEventListener('click', () => changeDay(1));
            document.getElementById('completeWorkoutBtn').addEventListener('click', completeWorkout);
        }

        // Handle week change
        function handleWeekChange(e) {
            state.currentWeek = parseInt(e.target.value);
            saveState();
            renderWorkout();
        }

        // Change day
        function changeDay(direction) {
            const maxDays = getMaxDays();
            const newDay = state.currentDay + direction;

            if (newDay >= 1 && newDay <= maxDays) {
                state.currentDay = newDay;
                saveState();
                renderWorkout();
            }
        }

        // Get day name
        function getDayName() {
            if (!state.workoutData || !state.workoutData.weeks) {
                return `Day ${state.currentDay}`;
            }

            const week = state.workoutData.weeks.find(w => w.week === state.currentWeek);
            if (!week || !week.days) return `Day ${state.currentDay}`;

            const day = week.days.find(d => d.day === state.currentDay);
            return day?.day_name ? `DAY ${state.currentDay}: ${day.day_name}` : `Day ${state.currentDay}`;
        }

        // Render workout
        function renderWorkout() {
            const container = document.getElementById('workoutContainer');
            const dayIndicator = document.getElementById('dayIndicator');
            const exercises = getCurrentExercises();

            // Update day indicator
            dayIndicator.textContent = getDayName();

            // Update navigation buttons
            const maxDays = getMaxDays();
            document.getElementById('prevDayBtn').classList.toggle('disabled', state.currentDay === 1);
            document.getElementById('nextDayBtn').classList.toggle('disabled', state.currentDay === maxDays);

            // Clear container
            container.innerHTML = '';

            if (exercises.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">💪</div>
                        <div class="empty-text">No workout scheduled</div>
                        <div class="empty-subtext">Rest day or select a different week/day</div>
                    </div>
                `;
                return;
            }

            // Render each exercise
            exercises.forEach((exercise, index) => {
                // Check if we should show weight suggestion
                if (shouldShowSuggestion(exercise)) {
                    const suggestionCard = createSuggestionForExercise(exercise);
                    if (suggestionCard) {
                        container.appendChild(suggestionCard);
                    }
                }

                const card = createExerciseCard(exercise, index + 1);
                container.appendChild(card);
            });
        }

        // Create exercise card
        function createExerciseCard(exercise, exerciseNumber) {
            const card = document.createElement('div');
            card.className = 'workout-card';
            card.setAttribute('data-exercise-id', exercise.id);

            // Use the actual previous results from JSON data
            const previousHTML = exercise.previousResults ? `
                <div class="previous-results">
                    <div class="previous-label">Previous Session</div>
                    <div class="previous-value">${exercise.previousResults}</div>
                </div>
            ` : '';

            card.innerHTML = `
                <div class="exercise-header">
                    <div class="exercise-name">
                        <strong>[${exercise.id}]</strong> ${exercise.name}
                    </div>
                    <div class="exercise-number">${exerciseNumber}</div>
                </div>

                <div class="exercise-details">
                    <div class="detail-item">
                        <div class="detail-label">Tempo</div>
                        <div class="detail-value">${exercise.tempo}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Sets/Reps</div>
                        <div class="detail-value">${exercise.setsRepsRaw}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Rest</div>
                        <div class="detail-value">${exercise.rest}</div>
                    </div>
                </div>

                <div class="sets-container">
                    <div class="set-header">Complete Each Set</div>
                    ${Array.from({ length: exercise.sets }, (_, i) => createSetRow(exercise, i + 1)).join('')}
                </div>

                ${previousHTML}
            `;

            // Add event listeners for inputs and checkboxes
            setTimeout(() => setupCardListeners(card, exercise), 0);

            return card;
        }

        // Create set row
        function createSetRow(exercise, setNumber) {
            const key = `${state.currentProgram}_w${state.currentWeek}_d${state.currentDay}_${exercise.id}_${setNumber}`;
            const saved = state.completedSets[key] || {};
            const isCompleted = saved.completed || false;

            return `
                <div class="set-row">
                    <div class="set-label">Set ${setNumber}</div>
                    <div class="input-group">
                        <label class="input-label">Weight</label>
                        <input
                            type="number"
                            class="input-field weight-input"
                            placeholder="0"
                            data-exercise="${exercise.id}"
                            data-set="${setNumber}"
                            value="${saved.weight || ''}"
                            inputmode="decimal"
                            step="0.5"
                        >
                    </div>
                    <div class="input-group">
                        <label class="input-label">Reps</label>
                        <input
                            type="number"
                            class="input-field reps-input"
                            placeholder="${exercise.reps}"
                            data-exercise="${exercise.id}"
                            data-set="${setNumber}"
                            value="${saved.reps || ''}"
                            inputmode="numeric"
                        >
                    </div>
                    <button
                        class="check-btn ${isCompleted ? 'completed' : ''}"
                        data-exercise="${exercise.id}"
                        data-set="${setNumber}"
                    >
                        <span class="checkmark">✓</span>
                    </button>
                </div>
            `;
        }

        // Setup card listeners
        function setupCardListeners(card, exercise) {
            // Weight inputs
            card.querySelectorAll('.weight-input').forEach(input => {
                input.addEventListener('input', (e) => handleInputChange(e, 'weight'));
                input.addEventListener('blur', saveState);
            });

            // Reps inputs
            card.querySelectorAll('.reps-input').forEach(input => {
                input.addEventListener('input', (e) => handleInputChange(e, 'reps'));
                input.addEventListener('blur', saveState);
            });

            // Check buttons
            card.querySelectorAll('.check-btn').forEach(btn => {
                btn.addEventListener('click', handleSetComplete);
            });
        }

        /**
         * Check if weight suggestion should be shown for this exercise
         */
        function shouldShowSuggestion(exercise) {
            // Only show in Week 2+
            if (state.currentWeek <= 1) {
                return false;
            }

            // Don't show if already dismissed
            if (isSuggestionDismissed(exercise.id)) {
                return false;
            }

            // Don't show if user already started entering weights
            if (hasUserStartedExercise(exercise.id)) {
                return false;
            }

            // Check if Week 1 data exists
            const week1Results = getWeek1Results(
                state.currentProgram,
                1,
                state.currentDay,
                exercise.id
            );

            return week1Results && week1Results.length > 0;
        }

        /**
         * Check if user has already started entering weights for this exercise
         */
        function hasUserStartedExercise(exerciseId) {
            const key = `${state.currentProgram}_w${state.currentWeek}_d${state.currentDay}_${exerciseId}_1`;
            const setData = state.completedSets[key];

            return setData && (setData.weight || setData.reps);
        }

        /**
         * Create suggestion card for an exercise
         */
        function createSuggestionForExercise(exercise) {
            // Get suggestion from engine
            const suggestion = getSuggestionForExercise(
                state.currentProgram,
                state.currentDay,
                exercise.id,
                exercise.setsRepsRaw
            );

            if (!suggestion) {
                return null;
            }

            // Render suggestion card
            return renderSuggestionCard(
                suggestion,
                handleSuggestionAccept,
                handleSuggestionModify,
                handleSuggestionDismiss
            );
        }

        /**
         * Handle suggestion acceptance
         */
        function handleSuggestionAccept(suggestion) {
            console.log('[UI] Accepted suggestion:', suggestion.exerciseId, suggestion.suggestedWeight);
            showToast(`Applied ${suggestion.suggestedWeight} lbs to all sets`);

            // Save state
            saveState();
        }

        /**
         * Handle suggestion modification
         */
        function handleSuggestionModify(suggestion) {
            console.log('[UI] Modified suggestion:', suggestion.exerciseId);
        }

        /**
         * Handle suggestion dismissal
         */
        function handleSuggestionDismiss(suggestion) {
            console.log('[UI] Dismissed suggestion:', suggestion.exerciseId);
            showToast('Suggestion dismissed');
        }

        // Handle input change
        function handleInputChange(e, type) {
            const exerciseId = e.target.dataset.exercise;
            const setNumber = e.target.dataset.set;
            const key = `${state.currentProgram}_w${state.currentWeek}_d${state.currentDay}_${exerciseId}_${setNumber}`;

            if (!state.completedSets[key]) {
                state.completedSets[key] = {};
            }

            // Parse to number to ensure correct storage format
            state.completedSets[key][type] = parseFloat(e.target.value) || 0;
        }

        // Handle set complete
        function handleSetComplete(e) {
            const btn = e.currentTarget;
            const exerciseId = btn.dataset.exercise;
            const setNumber = btn.dataset.set;
            const key = `${state.currentProgram}_w${state.currentWeek}_d${state.currentDay}_${exerciseId}_${setNumber}`;

            // Get weight and reps inputs
            const card = btn.closest('.workout-card');
            const weightInput = card.querySelector(`.weight-input[data-set="${setNumber}"]`);
            const repsInput = card.querySelector(`.reps-input[data-set="${setNumber}"]`);

            // Validate inputs
            if (!weightInput.value || !repsInput.value) {
                showToast('Please enter weight and reps first');
                return;
            }

            // Toggle completion
            const isCompleted = btn.classList.toggle('completed');

            if (!state.completedSets[key]) {
                state.completedSets[key] = {};
            }

            state.completedSets[key].completed = isCompleted;
            // Parse values to numbers to ensure correct storage format
            state.completedSets[key].weight = parseFloat(weightInput.value) || 0;
            state.completedSets[key].reps = parseInt(repsInput.value, 10) || 0;

            saveState();

            if (isCompleted) {
                showToast('Set completed!');
                // Vibration feedback if available
                if ('vibrate' in navigator) {
                    navigator.vibrate(50);
                }
            }
        }

        // Complete workout
        function completeWorkout() {
            const exercises = getCurrentExercises();

            let allCompleted = true;
            let totalSets = 0;
            let completedCount = 0;

            exercises.forEach(exercise => {
                for (let i = 1; i <= exercise.sets; i++) {
                    totalSets++;
                    const key = `${state.currentProgram}_w${state.currentWeek}_d${state.currentDay}_${exercise.id}_${i}`;
                    if (state.completedSets[key]?.completed) {
                        completedCount++;
                    } else {
                        allCompleted = false;
                    }
                }
            });

            if (allCompleted && totalSets > 0) {
                showToast('Workout completed! Great job!');
                // Vibration feedback
                if ('vibrate' in navigator) {
                    navigator.vibrate([100, 50, 100]);
                }
            } else {
                showToast(`${completedCount}/${totalSets} sets completed`);
            }
        }

        // Show toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        // Save state to localStorage
        function saveState() {
            try {
                localStorage.setItem('workoutTrackerState', JSON.stringify(state));
            } catch (e) {
                console.error('Failed to save state:', e);
            }
        }

        // Load state from localStorage
        function loadState() {
            try {
                const saved = localStorage.getItem('workoutTrackerState');
                if (saved) {
                    const parsedState = JSON.parse(saved);
                    // Only restore certain properties
                    if (parsedState.currentWeek) state.currentWeek = parsedState.currentWeek;
                    if (parsedState.currentDay) state.currentDay = parsedState.currentDay;
                    if (parsedState.completedSets) state.completedSets = parsedState.completedSets;
                    if (parsedState.previousResults) state.previousResults = parsedState.previousResults;

                    // Update UI
                    document.getElementById('weekSelector').value = state.currentWeek;
                }
            } catch (e) {
                console.error('Failed to load state:', e);
            }
        }

        // Auto-migrate old data from strings to numbers (bug fix)
        function autoMigrateData() {
            try {
                if (!state.completedSets || Object.keys(state.completedSets).length === 0) {
                    return; // No data to migrate
                }

                let migratedCount = 0;
                let needsSave = false;

                Object.keys(state.completedSets).forEach(key => {
                    const set = state.completedSets[key];

                    // Fix weight if it's a string
                    if (set.weight !== undefined && typeof set.weight === 'string') {
                        const oldValue = set.weight;
                        set.weight = parseFloat(set.weight) || 0;
                        console.log(`[Migration] Fixed weight: "${oldValue}" → ${set.weight}`);
                        migratedCount++;
                        needsSave = true;
                    }

                    // Fix reps if it's a string
                    if (set.reps !== undefined && typeof set.reps === 'string') {
                        const oldValue = set.reps;
                        set.reps = parseInt(set.reps, 10) || 0;
                        console.log(`[Migration] Fixed reps: "${oldValue}" → ${set.reps}`);
                        migratedCount++;
                        needsSave = true;
                    }
                });

                if (needsSave) {
                    saveState();
                    console.log(`[Migration] ✅ Migrated ${migratedCount} values from strings to numbers`);
                    showToast(`Data migrated: Fixed ${migratedCount} values`, 3000);
                }
            } catch (e) {
                console.error('[Migration] Failed to migrate data:', e);
            }
        }

        // Service Worker Registration (PWA)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed'));
            });
        }

        // Add sample Week 1 data for testing (can be removed later)
        function addSampleWeek1Data() {
            // Only add if no data exists yet
            const existingData = localStorage.getItem('sheet1_w1_d1_A1_1');
            if (existingData) return;

            console.log('[Testing] Adding sample Week 1 data...');

            // Sample data for A1 (Barbell Bench Press)
            localStorage.setItem('sheet1_w1_d1_A1_1', JSON.stringify({weight: 145, reps: 20, completed: true}));
            localStorage.setItem('sheet1_w1_d1_A1_2', JSON.stringify({weight: 145, reps: 20, completed: true}));
            localStorage.setItem('sheet1_w1_d1_A1_3', JSON.stringify({weight: 145, reps: 19, completed: true}));

            // Update completedSets in state
            const stateStr = localStorage.getItem('workoutTrackerState');
            const savedState = stateStr ? JSON.parse(stateStr) : {};

            if (!savedState.completedSets) {
                savedState.completedSets = {};
            }

            savedState.completedSets['sheet1_w1_d1_A1_1'] = {weight: 145, reps: 20, completed: true};
            savedState.completedSets['sheet1_w1_d1_A1_2'] = {weight: 145, reps: 20, completed: true};
            savedState.completedSets['sheet1_w1_d1_A1_3'] = {weight: 145, reps: 19, completed: true};

            localStorage.setItem('workoutTrackerState', JSON.stringify(savedState));

            console.log('[Testing] Sample Week 1 data added!');
        }

        // Initialize app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                addSampleWeek1Data();
                initApp();
            });
        } else {
            addSampleWeek1Data();
            initApp();
        }

        // Prevent pull-to-refresh on mobile
        let touchStartY = 0;
        document.addEventListener('touchstart', (e) => {
            touchStartY = e.touches[0].clientY;
        }, { passive: true });

        document.addEventListener('touchmove', (e) => {
            const touchY = e.touches[0].clientY;
            const touchDiff = touchY - touchStartY;
            if (touchDiff > 0 && window.scrollY === 0) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>